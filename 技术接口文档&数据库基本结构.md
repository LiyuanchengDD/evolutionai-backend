# 一,登陆注册页面接口技术文档
  ## 1.沿用原有官网的登陆注册流程
  ## 2.接口设计：
    企业端（role:company）
      POST /api/b/auth/send-code（发送注册验证码）
      POST /api/b/auth/register（注册：验证码+密码）
      POST /api/b/auth/login（登录：邮箱+密码）
    工程师端（role:engineer）
      POST /api/c/auth/send-code
      POST /api/c/auth/register
      POST /api/c/auth/login
  ## 3.数据库设计
    user表
  | 字段                          | 类型                                | 说明        |
  | `id`                        | UUID                              | 主键        |
  | `email`                     | CITEXT UNIQUE                     | 登录邮箱（忽略大小写） |
  | `password_hash`             | VARCHAR                           | BCrypt 哈希 |
  | `role`                      | ENUM(company, engineer, admin)   | 角色（与接口中的 role 参数一致） |
  | `status`                    | ENUM(ACTIVE, PENDING, LOCKED)     | 状态        |
  | `created_at` / `updated_at` | TIMESTAMP                         | 创建/更新时间   |
  | `last_login_at`             | TIMESTAMP                         | 最近登录      |
    
    验证码表 verification_tokens
  | 字段           | 类型                                  | 说明     |
  | `id`         | UUID                                | 主键     |
  | `email`      | VARCHAR(255)                        | 对应用户邮箱 |
  | `code`       | VARCHAR(6)                          | 验证码    |
  | `purpose`    | ENUM(REGISTRATION, RESET\_PASSWORD) | 用途     |
  | `expires_at` | TIMESTAMP                           | 过期时间   |
  | `consumed`   | BOOLEAN                             | 是否已使用  |
  | `created_at` | TIMESTAMP                           | 创建时间   |

# 二,企业端注册四步引导功能
  ## 1.功能概述
    适用角色：已完成邮箱注册并首次登录的企业用户（B 端）
  ## 2.API设计
    | 方法     | URI                                 | 描述                  |
    | `GET`  | `/api/enterprise/onboarding/state`  | 查询当前进度、已保存数据与可用变量列表 |
    | `POST` | `/api/enterprise/onboarding/step1`  | 保存企业基础信息            |
    | `POST` | `/api/enterprise/onboarding/step2`  | 保存 HR 联系人信息         |
    | `POST` | `/api/enterprise/onboarding/step3`  | 保存邀约邮件模板            |
    | `POST` | `/api/enterprise/onboarding/verify` | 校验邮箱验证码并完成引导        |
    | `GET`  | `/api/enterprise/onboarding/locations/countries` | 获取国家下拉列表（ISO 3166-1 alpha-2） |
    | `GET`  | `/api/enterprise/onboarding/locations/cities` | 获取指定国家的 ISO 3166-2 城市/省份 |

    - `EmployeeScale` 六档：50 人以下 / 50-200 人 / 200-500 人 / 500-1000 人 / 1000-5000 人 / 5000 人以上。
    - `AnnualHiringPlan` 六档：1-10 人 / 10-50 人 / 50-100 人 / 100-200 人 / 200-300 人 / 300 人以上。
  ## 3.数据库设计
    company_profiles 表（企业主体信息）
      | 字段               | 类型            | 说明 |
      | `company_id`       | CHAR(36) (PK)   | 企业 ID（UUID） |
      | `owner_user_id`    | CHAR(36)        | 注册账号的用户 ID，用于去重 |
      | `company_name`     | VARCHAR(255)    | 企业全称 |
      | `company_short_name` | VARCHAR(255)  | 企业简称 |
      | `social_credit_code` | VARCHAR(64)   | 统一社会信用代码 |
      | `employee_scale`     | ENUM            | 企业规模（`EmployeeScale` 枚举）|
      | `annual_hiring_plan` | ENUM            | 年度招聘计划（`AnnualHiringPlan` 枚举）|
      | `industry`           | VARCHAR(255)    | 行业 |
      | `country_code`       | VARCHAR(8)      | 国家代码（ISO 3166-1 alpha-2）|
      | `city_code`          | VARCHAR(16)     | 城市/省份代码（ISO 3166-2）|
      | `website`          | VARCHAR(255)    | 官网地址 |
      | `description`      | VARCHAR(1000)   | 企业简介 |
      | `detailed_address` | VARCHAR(255)    | 详细地址 |
      | `status`           | ENUM            | `ONBOARDING` / `ACTIVE` |
      | `created_at`/`updated_at` | TIMESTAMP | 审计字段 |
    company_contacts 表（企业联系人）
      | 字段                 | 类型          | 说明 |
      | `contact_id`         | CHAR(36) (PK) | 联系人 ID |
      | `company_id`         | CHAR(36)      | 关联企业 ID |
      | `user_account_id`    | CHAR(36)      | 对应登录账号 ID，可空 |
      | `contact_name`       | VARCHAR(128)  | 联系人姓名 |
      | `contact_email`      | VARCHAR(255)  | 联系人邮箱 |
      | `phone_country_code` | VARCHAR(8)    | 区号，例如 `+86` |
      | `phone_number`       | VARCHAR(32)   | 手机号/座机号 |
      | `position`           | VARCHAR(128)  | 职位 |
      | `department`         | VARCHAR(128)  | 部门 |
      | `is_primary`         | BOOLEAN       | 是否为主联系人 |
      | `created_at`/`updated_at` | TIMESTAMP | 审计字段 |
    company_recruiting_positions 表（企业在招岗位）
      | 字段                 | 类型           | 说明 |
      | `position_id`       | CHAR(36) (PK)  | 岗位记录 ID |
      | `company_id`        | CHAR(36)       | 关联企业 ID |
      | `position_name`     | VARCHAR(255)   | 岗位名称（AI 解析或人工编辑）|
      | `position_location` | VARCHAR(255)   | 工作地点，可空 |
      | `publisher_nickname` | VARCHAR(255)  | 发布人昵称，可空 |
      | `position_status`   | ENUM           | `DRAFT_PARSED` / `READY` / `PUBLISHED` / `CLOSED` / `PARSE_FAILED` |
      | `position_source`   | ENUM           | 创建来源：`AI_IMPORT` / `MANUAL` |
      | `document_id`       | CHAR(36)       | 关联 `company_job_documents` 的解析记录，可空 |
      | `created_at`/`updated_at` | TIMESTAMP | 审计字段 |
    company_job_documents 表（岗位解析快照）
      | 字段                | 类型           | 说明 |
      | `document_id`      | CHAR(36) (PK)  | 文档记录 ID |
      | `position_id`      | CHAR(36)       | 关联岗位 ID |
      | `file_name`        | VARCHAR(255)   | 上传时的原始文件名 |
      | `file_type`        | VARCHAR(100)   | MIME 类型，例如 `application/pdf` |
      | `file_content`     | BYTEA          | PDF 二进制内容，用于岗位详情页还原原始文档 |
      | `upload_user_id`   | CHAR(36)       | 上传者用户 ID |
      | `ai_raw_result`    | TEXT           | AI 原始返回 JSON 或错误信息 |
      | `parsed_title`     | VARCHAR(255)   | AI 解析出的岗位名称，可空 |
      | `parsed_location`  | VARCHAR(255)   | AI 解析出的地点，可空 |
      | `parsed_publisher` | VARCHAR(255)   | AI 解析出的发布人昵称，可空 |
      | `confidence`       | DECIMAL(5,2)   | AI 置信度，可空 |
      | `created_at`/`updated_at` | TIMESTAMP | 审计字段 |
    invitation_templates 表（邀约模版）
      | 字段            | 类型           | 说明 |
      | `template_id`   | CHAR(36) (PK)  | 模版 ID |
      | `company_id`    | CHAR(36)       | 关联企业 ID |
      | `template_name` | VARCHAR(255)   | 模版名称 |
      | `subject`       | VARCHAR(255)   | 邮件主题 |
      | `body`          | VARCHAR(5000)  | 邮件正文（可包含变量占位符）|
      | `language`      | VARCHAR(32)    | 语言标识，默认 `zh`（支持 `zh`/`en`/`jp`） |
      | `is_default`    | BOOLEAN        | 是否为默认模版 |
      | `created_at`/`updated_at` | TIMESTAMP | 审计字段 |
    verification_tokens 表（验证码记录）
      | 字段             | 类型           | 说明 |
      | `token_id`       | CHAR(36) (PK)  | 验证码记录 ID |
      | `target_user_id` | CHAR(36)       | 触发验证码的用户 ID |
      | `target_email`   | VARCHAR(255)   | 收码邮箱 |
      | `code`           | VARCHAR(16)    | 验证码内容 |
      | `channel`        | ENUM           | 发送渠道（EMAIL/SMS）|
      | `purpose`        | ENUM           | 验证用途，企业引导为 `ENTERPRISE_ONBOARDING` |
      | `expires_at`     | TIMESTAMP      | 过期时间 |
      | `consumed`       | BOOLEAN        | 是否已使用 |
      | `created_at`/`updated_at` | TIMESTAMP | 审计字段 |
  ## 4.错误处理
    | 场景                 | 返回码 | 错误码                     | 说明 |
    | -------------------- | ------ | ------------------------- | ---- |
    | 参数校验失败         | 400    | `VALIDATION_ERROR`        | 字段未满足 Bean Validation |
    | 未按顺序提交步骤     | 400    | `MISSING_PREVIOUS_STEP`   | 需要先完成上一阶段 |
    | 模版包含未支持变量   | 400    | `INVALID_TEMPLATE_VARIABLE` | `[[...]]` 不在允许列表 |
    | 国家/城市编码无效   | 400    | `INVALID_LOCATION`         | 国家或城市不在支持列表 |
    | 验证码不存在或不匹配 | 400    | `INVALID_VERIFICATION_CODE` | 未找到有效验证码 |
    | 验证码已过期         | 400    | `VERIFICATION_CODE_EXPIRED` | 过期时间早于当前时间 |
    | 已经完成过引导       | 409    | `ONBOARDING_ALREADY_COMPLETED` | 重复提交 |

  # 三,企业资料维护页面
   ## 1.功能概述
     入口：企业端左上角“资料信息”，分为左侧岗位概览与右侧资料编辑区域。
     - 左栏沿用 `company_profiles` 与 `company_recruiting_positions` 数据，展示企业信息及岗位卡列表。
     - 右栏支持修改企业主体信息、维护 HR 列表、新增 HR 账号、生成安全密码、下拉选择国际区号。
     所有接口需要传入企业所有者的 `userId` 用于权限校验，支持 `Accept-Language`（`zh`/`en`/`jp`）返回本地化国家/城市/区号名称。

   ## 2.API 设计
     | 方法 | URI | 描述 |
     | `GET` | `/api/enterprise/profile` | 根据 `userId` 返回企业概览与 HR 列表 |
     | `PUT` | `/api/enterprise/profile/company` | 更新企业主体信息与在招岗位列表 |
     | `POST` | `/api/enterprise/profile/hr` | 新增 HR（自动创建登录账号，可选自定义密码）|
     | `PUT` | `/api/enterprise/profile/hr/{contactId}` | 更新既有 HR 信息，可重置密码 |
     | `GET` | `/api/enterprise/profile/calling-codes` | 返回国家/地区电话区号列表 |
     | `GET` | `/api/enterprise/profile/password/suggestion` | 生成一组强密码供前端展示 |

   ## 3.请求与返回说明
     - 企业信息更新 `CompanyInfoUpdateRequest`：字段与引导步骤 1 保持一致，`recruitingPositions[]` 最多 50 项，后端会自动去重、裁剪空白。
     - HR 创建 `CreateHrRequest`：必填 `contactName`、`contactEmail`、`phoneCountryCode`、`phoneNumber`，`password` 可空（为空时后端生成 12 位强密码并在响应返回一次）。
     - HR 更新 `HrContactUpdateRequest`：除基础字段外新增 `newPassword`，若填写则同步更新/创建登录账号并在响应 `password` 字段透出。
     - `CompanyProfileResponse` 返回企业 ID、企业信息快照（含 `countryDisplayName`、`recruitingPositions`）、`hrContacts[]`（含 `userAccountId`、`primary` 标记）。
     - 区号列表 `CallingCodeDto`：`countryCode`（ISO 3166-1）、`countryName`（按 `Accept-Language` 转换）、`callingCode`（形如 `+81`）。

   ## 4.交互补充
     - 新建/重置密码会自动使用 BCrypt 加密写入 `user_accounts`，角色固定为 `company`，状态 `ACTIVE`。
     - `primary=true` 时会自动取消其他联系人主联系人标记。
     - 区号列表使用 libphonenumber 元数据即时生成，无需额外配置。

   ## 5.数据库设计更新
     `company_contacts` 表新增字段 `user_account_id UUID REFERENCES public.user_accounts(user_id) ON DELETE SET NULL`，并创建索引 `company_contacts_user_account_id_idx`，用于映射可登录的 HR 账号。

  # 四,企业端（岗位引导与卡片管理）
   ## 1.功能概述
      触发条件：企业用户首次登录且岗位列表为空，系统需弹出三步引导。上传 JD 后由 AI 自动抽取“岗位名称 / 工作地点 / 发布人昵称”，若解析异常则允许 HR 手动修正并保存。
   ## 2.API 设计
      所有接口由 `/api/enterprise/jobs` 提供：
      | 方法 | URI | 描述 |
      | --- | --- | --- |
      | `GET` | `/summary` | 根据 `companyId` 或 `userId` 返回岗位总数与是否展示引导弹窗。|
      | `GET` | `/`（根路径） | 返回岗位卡片列表，包含名称、地点、发布人昵称、状态、更新时间，按更新时间倒序。|
      | `POST` | `/import` | `multipart/form-data` 上传 PDF，调用 AI 解析生成岗位草稿并返回详情。|
      | `GET` | `/{positionId}` | 获取单个岗位详情，附带 AI 解析文档快照。|
      | `PATCH` | `/{positionId}` | 更新岗位名称/地点/发布人或状态，保存后同步刷新更新时间。|
      > `companyId` 与 `userId` 至少提供其一；解析失败时返回的状态为 `PARSE_FAILED`，前端需提示进入手动编辑流程。

   ## 3.数据与状态
      - 岗位数据落在 `company_recruiting_positions` 表，新增字段 `position_location`、`publisher_nickname`、`position_status`、`position_source`、`document_id` 与 UI 展示保持一致。
      - 每次导入都会写入一条 `company_job_documents` 记录，保存上传文件元数据、PDF 二进制内容与 AI 原始返回，便于排查解析质量并支撑岗位详情页预览原始文档。
      - 岗位详情接口 `JobDetailResponse.document.documentHtml` 返回 `<iframe>` HTML 字符串，前端可直接插入岗位描述区域展示 HR 上传的 PDF。
      - 岗位状态枚举：
        - `DRAFT_PARSED`：AI 已解析完成，待 HR 校验。
        - `READY`：HR 已确认字段，等待发布。
        - `PUBLISHED`：已正式上线。
        - `CLOSED`：已下线。
        - `PARSE_FAILED`：AI 解析失败，需人工录入。
      - 创建来源 `position_source` 区分 `AI_IMPORT` 与 `MANUAL`，便于后续数据分析。

   ## 4.AI 解析服务
      - 默认通过 `RestJobDescriptionParser` 调用外部 HTTP 服务（`ai.job-parser.base-url`，默认 `http://localhost:8090`），请求体为 Base64 编码的 PDF 内容。
      - 测试环境自动切换为 `StubJobDescriptionParser`，直接从文件名生成占位标题，方便本地联调。
      - 解析成功返回结构化字段写入岗位卡片；若抛出异常，系统仍创建岗位记录但标记为 `PARSE_FAILED` 并在文档表中记录错误信息。
  
  # 五,企业端岗位候选人导入与管理
   ## 1.功能概述
     在企业端岗位详情页支持批量导入候选人简历，自动解析并维护候选人信息、状态、邮件邀约与面试记录。
   ## 2.状态机定义（JobCandidateStatus）
     | 状态代码             | 描述          | 触发条件                  |
     | `INVITE_PENDING` | 待邀约         | HR 尚未发送邮件，邮箱有效        |
     | `INVITE_SENT`    | 已发送邀约 / 未面试 | 通知服务发送成功，但候选人未开始面试    |
     | `IN_PROGRESS`    | 面试中         | 候选人正在答题               |
     | `COMPLETED`      | 已面试         | 面试提交完成，生成面试记录         |
     | `REPORT_READY`   | 报告已生成       | Report Service 完成评估报告 |
     | `DECLINED`       | 已放弃         | 候选人主动放弃（邮件链接）         |
     | `TIMEOUT`        | 已超时         | 邀约超过 15 天未响应          |
     | `EMAIL_MISSING`  | 邮箱缺失        | 解析未得到邮箱               |
     | `INVALID`        | 解析失败        | AI 解析异常或文件损坏          |
  ## 3.API 设计
     1）候选人批量导入
       - 接口：`POST /api/enterprise/jobs/{positionId}/candidates/import`
       - `multipart/form-data`，参数：`uploaderUserId`（必填）+ `files[]`（必填，可多份）。
       - 后端逐份调用 AI 简历解析器，产出姓名/邮箱/电话/HTML 文本；若解析失败依旧建档但标记邮箱缺失。
     2）查询岗位候选人列表
       - 接口：`GET /api/enterprise/jobs/{positionId}/candidates`
       - 查询参数：`keyword`（姓名/邮箱/电话模糊搜索，可空）。
       - 返回 `JobCandidateListResponse`，包含候选人数组及 `summary`（待邀约、已邀约、邮箱缺失、面试进度等聚合计数）。
     3）更新候选人基础信息
       - 接口：`PATCH /api/enterprise/job-candidates/{jobCandidateId}`
       - 请求体：`JobCandidateUpdateRequest`，支持更新姓名、邮箱、电话、邀约状态、面试状态及可编辑的 `resumeHtml`。
       - 邮箱清空会自动重置 `inviteStatus=EMAIL_MISSING`，补齐邮箱默认回到 `INVITE_PENDING`。
     4）获取候选人简历详情
       - 接口：`GET /api/enterprise/job-candidates/{jobCandidateId}/resume`
       - 返回 `JobCandidateResumeResponse`，包含基本信息、AI 解析 HTML 片段，以及可直接 `<iframe>` 展示的原始 PDF。
     5）发送面试邀约邮件
       - 接口：`POST /api/enterprise/job-candidates/{jobCandidateId}/invite`
       - 请求体：`JobCandidateInviteRequest`，可指定 `templateId` 或附加 `cc[]`；若不传则使用企业默认模版。
       - 成功后写入 `inviteStatus=INVITE_SENT`，失败写入 `INVITE_FAILED` 并返回 500。
     6）岗位搜索增强
       - `GET /api/enterprise/jobs` 新增 `keyword` 参数，后端按岗位名称模糊筛选。
     7）后续扩展（暂未实现）
       - 面试记录、AI 报告查询、状态同步任务保留原设计接口，待面试服务落地后接入。
   ## 4.AI服务交互
    | 场景     | 调用方向                                      | 接口                 | 说明                               |
    | 简历解析   | Candidate Service → AI Resume Parser      | `POST /internal/ai/resume-parser`      | 输入简历文件 URL，输出姓名/邮箱/电话/教育经历等结构化数据 |
    | 面试题目生成 | Interview Service → AI Question Generator | `POST /internal/ai/generate-questions` | 根据岗位和候选人特征生成 15 道题目|
    | 语音转文字  | Interview Service → AI Speech-to-Text     | `POST /internal/ai/stt`                | 上传音频，返回转写文本 |
    | 面试评估   | Report Service → AI Evaluation            | `POST /internal/ai/evaluate`           | 输入问答内容，返回评分和评语 |
   ## 5.数据库设计
     job_candidates 表（岗位-候选人关联）
      | 字段 | 类型 | 说明 |
      | `job_candidate_id` | UUID (PK) | 候选人记录 ID |
      | `position_id` | UUID | 关联岗位 ID，外键指向 `company_recruiting_positions` |
      | `candidate_name` | VARCHAR(255) | 候选人姓名（AI 解析或人工维护）|
      | `candidate_email` | VARCHAR(255) | 邮箱，缺失时 `invite_status=EMAIL_MISSING` |
      | `candidate_phone` | VARCHAR(64) | 联系电话 |
      | `invite_status` | ENUM | `INVITE_PENDING` / `INVITE_SENT` / `INVITE_FAILED` / `EMAIL_MISSING` |
      | `interview_status` | ENUM | `NOT_INTERVIEWED` / `SCHEDULED` / `IN_PROGRESS` / `COMPLETED` / `CANCELLED` |
      | `resume_id` | UUID | 关联 `job_candidate_resumes`（1:1，可空）|
      | `uploader_user_id` | UUID | 导入人用户 ID |
      | `created_at` / `updated_at` | TIMESTAMP | 审计字段 |

     job_candidate_resumes 表（简历原文及解析快照）
      | 字段 | 类型 | 说明 |
      | `resume_id` | UUID (PK) | 简历记录 ID |
      | `job_candidate_id` | UUID | 外键，级联删除 |
      | `file_name` / `file_type` | VARCHAR | 上传原始文件信息 |
      | `file_content` | BYTEA | 原始 PDF 二进制，用于预览 |
      | `parsed_name` / `parsed_email` / `parsed_phone` | VARCHAR | AI 解析出的关键信息 |
      | `parsed_html` | TEXT | AI 解析的 HTML 富文本（可编辑）|
      | `confidence` | DECIMAL(5,2) | AI 置信度 |
      | `ai_raw_result` | TEXT | AI 返回的原始 JSON 或错误消息 |
      | `created_at` / `updated_at` | TIMESTAMP | 审计字段 |

     后续落地面试模块时，将在此基础上扩展 `interviews`、`interview_records` 等表，并通过事件或定时任务维护 `interview_status`。
  
  # 六,候选人后端功能
   ## 1.功能概述
     目标：为候选人提供面试邀请查看、设备检测、在线答题与面试状态管理能力。
   ## 2.API设计
     1）设备检测结果上报
     POST /api/candidate/interviews/{interviewId}/device-check
     2）获取面试题目
     GET /api/candidate/interviews/{interviewId}/questions
     3）答题提交（逐题）
     POST /api/candidate/interviews/{interviewId}/answers
     4）面试完成
     POST /api/candidate/interviews/{interviewId}/complete
     5）放弃面试
     POST /api/candidate/interviews/{interviewId}/abandon
   ## 3.状态机
    | 状态            | 描述         | 触发条件        |
    | ------------- | ---------- | ----------- |
    | `INVITED`     | 已收到邀请      | 面试邀约创建      |
    | `READY`       | 设备检测通过，可面试 | 设备检测全部 PASS |
    | `IN_PROGRESS` | 面试进行中      | 开始答题        |
    | `COMPLETED`   | 面试完成       | 所有题目提交      |
    | `DECLINED`    | 候选人放弃      | 点击放弃        |
    | `TIMEOUT`     | 超时未作答      | 后台任务判定      |
   ## 4.数据结构
   interviews表
   interview_questions表
   interview_answers表
   device_checks表
  
  # 待处理事项
   ## ？候选人没上传自己的头像之前是无法答题的么？文案提供一下
   ## 企业端候选人的搜索，应该用后端模糊查询。因为需要分页
   ## 登陆注册页面：自己写